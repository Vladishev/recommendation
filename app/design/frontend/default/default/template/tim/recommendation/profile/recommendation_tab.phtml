<?php $_helper = Mage::helper('tim_recommendation'); ?>
<?php $avatarsPath = $_helper->getDefaultAvatarsPath(); ?>
<?php $avatarFiles = $_helper->getDefaultAvatarsFile(); ?>
<form action="<?php echo $this->getUrl('recommendation/user/saveCustomer') ?>" method="post" id="form-validate" autocomplete="off" enctype="multipart/form-data">
<div class="fieldset">
    <h2 class="legend"><?php echo $this->__('Recommendation Information') ?></h2>
    <ul class="form-list">
        <li>
            <label for="url"><?php echo $_helper->__('WWW') ?></label>
            <div class="input-box">
                <input type="text" name="url" id="tim-form-url" class="input-text custom-url-validate" value="<?php echo $_helper->getSiteUrl(); ?>" />
            </div>
        </li>
        <li>
            <label class="required" for="nick"><em>*</em><?php echo $_helper->__('Nick') ?></label>
            <div class="input-box">
                <input type="text" name="nick" id="nick" class="input-text required-entry" value="<?php echo $_helper->getUserNick(); ?>" />
            </div>
        </li>
        <li>
            <label for="banner"><?php echo $_helper->__('Banner') ?></label>
            <div class="input-box">
                <input type="file" name="banner" id="banner" class="upload-buttons" title="<?php echo $_helper->__('Allowed file types: jpeg, png.') ?>" accept="image/jpeg,image/png" />
                <input type="hidden" name="banner-hide" id="banner-hide"  value="" />
            </div>
            <?php if($_helper->getCustomerBanner()): ?>
                <label for="banner-checkbox"><?php echo $_helper->__('Delete') ?></label>
                <input type="checkbox" name="banner-checkbox" id="banner-checkbox" title="<?php echo $_helper->__('Choose it if you want to delete image.') ?>">
            <div class="recommendation-image">
                <img src="<?php echo $_helper->getCustomerBanner(); ?>" id="tim-banner-image" width="860" height="500" alt="banner" />
            </div>
            <?php endif ?>
        </li>
<!--   ----------------------------------------------------------------------------     -->
<!--        <div>-->
<!--            <input type="file" name="upload-image" id="upload-image" title="--><?php //echo $_helper->__('Allowed file types: jpeg, png.') ?><!--" accept="image/jpeg,image/png" />-->
<!--            <input type="hidden" name="tim-cropped-image-path" id="tim-cropped-image-path"  value="" />-->
<!--            <img src="" id="tim-avatar-preview" alt="Preview"/>-->
<!--        </div>-->
<!--   ----------------------------------------------------------------------------     -->
        <li>
            <label><?php echo $_helper->__('Avatar') ?></label><br>
            <div class="avatar">
                <label><?php echo $_helper->__('Choose your avatar from a list') ?></label>
                <div class="default-avatar"><br>
                    <?php $i = 1 ?>
                    <?php foreach($avatarsPath as $avatar): ?>
                        <input type="radio" name="selected_avatar" value="<?php echo $avatarFiles[$i-1]; ?>">
                        <img src="<?php echo $avatar; ?>" width="60" height="40" alt="avatar<?php echo $i; ?>" />
                        <?php echo $_helper->__('Avatar %s',$i); ?><br>
                    <?php $i++; endforeach;?>
                </div>
                <label for="image"><?php echo $_helper->__('Add your avatar') ?></label>
                <div class="input-box">
                    <input type="file" name="avatar" id="avatar" class="upload-buttons" title="<?php echo $_helper->__('Allowed file types: jpeg, png.') ?>" accept="image/jpeg,image/png"/>
                    <input type="hidden" name="avatar-hide" id="avatar-hide"  value="" />
                </div>
                <?php if($_helper->getCustomerAvatar()): ?>
                    <label for="avatar-checkbox"><?php echo $_helper->__('Delete') ?></label>
                    <input type="checkbox" name="avatar-checkbox" id="avatar-checkbox" title="<?php echo $_helper->__('Choose it if you want to delete image.') ?>">
                    <div class="recommendation-image">
                        <img src="<?php echo $_helper->getCustomerAvatar(); ?>" id="tim-avatar-image" width="290" height="180" alt="avatar" />
                    </div>
                <?php endif ?>
            </div>
        </li>
        <li>
            <label for="description"><?php echo $_helper->__('Description') ?></label>
            <div class="input-box">
                <textarea name="description" id="tim-form-description" class="input-textarea"><?php echo $_helper->getCustomerDescription(); ?></textarea>
            </div>
        </li>
        <?php
        $userTypes = $_helper->getNonAdminUserTypes();
        $customerUserTypeId = $_helper->getCustomerUserTypeId($this->getCustomer()->getEntityId());
        ?>
        <?php if(!empty($userTypes)): ?>
            <li>
                <label for="user_type" class="required"><em>*</em><?php echo $_helper->__('User type') ?></label>
                <div class="input-box">
                    <select id="tim-form-user-type" name="user_type" class="user-type-select required-entry">
                        <option value=""><?php echo $_helper->__('--Select user type--') ?></option>
                        <?php foreach ($userTypes as $type): ?>
                            <option value="<?php echo $type['user_type_id'];?>" <?php if($type['user_type_id'] == $customerUserTypeId): ?>selected="selected"<?php endif ?>><?php echo $type['name'];?></option>
                        <?php endforeach ?>
                    </select>
                </div>
            </li>
        <?php endif; ?>
    </ul>
</div>
<div class="buttons-set">
    <p class="required"><?php echo $this->__('* Required Fields') ?></p>
    <p class="back-link"><a href="<?php echo $this->escapeUrl($this->getBackUrl()) ?>"><small>&laquo; </small><?php echo $this->__('Back') ?></a></p>
    <button type="submit" title="<?php echo Mage::helper('core')->quoteEscape($this->__('Save')) ?>" class="button" ><span><span><?php echo $this->__('Save') ?></span></span></button>
</div>
</form>
<!---------------------------------------------------------------------------------------->

<div class="tim-crop-image">
    <div class="tim-crop-image-bg"></div>
    <div class="tim-crop-image-container">
        <input type="button" class="tim-popup-close" value="x"/>
        <img id="image-test" src="" width="300" height="300" alt="banner" />
        <button type="button" id="test-btn" class="btn btn-primary docs-buttons" data-method="getCroppedCanvas">
            <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;getCroppedCanvas&quot;)">
              Get Cropped Canvas
            </span>
        </button>
    </div>
</div>
<!---------------------------------------------------------------------------------------->
<script type="text/javascript">
    //<![CDATA[

//    -------------------------------------------------------------------------------------

    var $image = jQuery('#image-test');

    $image.cropper({
        minCropBoxWidth: 200,
        aspectRatio: 5 / 5,
        crop: function(e) {}
    });

    var $inputImage = jQuery('.upload-buttons');
    $inputImage.on('click', function () {
        $inputImage = jQuery(this);
    });
//    var $inputImage = jQuery('#banner');
    var URL = window.URL || window.webkitURL;
    var blobURL;
    var $popUp = jQuery('.tim-crop-image');

    if (URL) {
        $inputImage.change(function () {
            var files = this.files;
            var file;

            if (!$image.data('cropper')) {
                return;
            }
            $popUp.show(300);
            if (files && files.length) {
                file = files[0];

                if (/^image\/\w+$/.test(file.type)) {
                    blobURL = URL.createObjectURL(file);
                    $image.one('built.cropper', function () {

                        // Revoke when load complete
                        URL.revokeObjectURL(blobURL);
                    }).cropper('reset').cropper('replace', blobURL);
                    $inputImage.val('');
                } else {
                    window.alert('Please choose an image file.');
                }
            }
        });
    } else {
        $inputImage.prop('disabled', true).parent().addClass('disabled');
    }

    // Methods
    jQuery('.docs-buttons').on('click', function () {
        var $this = jQuery(this);
        var data = $this.data();
        var $target;
        var result;
        var date = new Date();
        var buttonType = $inputImage.attr('id');

        if ($this.prop('disabled') || $this.hasClass('disabled')) {
            return;
        }

        if ($image.data('cropper') && data.method) {

            data = jQuery.extend({}, data); // Clone a new one
            if (typeof data.target !== 'undefined') {

                $target = jQuery(data.target);
                if (typeof data.option === 'undefined') {
                    try {
                        data.option = JSON.parse($target.val());
                    } catch (e) {
                        console.log(e.message);
                    }
                }
            }

            result = $image.cropper(data.method, data.option, data.secondOption);
            var sendData = {data: result.toDataURL(), typeOfImage: buttonType, customerId: <?php echo Mage::helper('customer')->getCustomer()->getEntityId() ?>};

            jQuery.ajax({
                url: "<?php echo $this->getUrl('recommendation/user/saveCropImage') ?>",
                type: "post",
                data: sendData,
                success: function(response){
                    var response = JSON.parse(response);
                    var $preview = jQuery('#tim-'+buttonType+'-image');
                    $preview.attr('src', response['path']+'?'+date.getTime());
                    jQuery('#'+buttonType+'-hide').attr('value', response['formData']);
                    $popUp.hide();
                }
            });
        }
    });

//    ---------------------------------------------------------------------------------------
    var dataForm = new VarienForm('form-validate', true);
    Validation.add('custom-url-validate', 'Please enter a valid URL. For example http://www.example.com or www.example.com or example.com', function () {
        var url = document.getElementById("tim-form-url").value;
        var pattern = /([a-zA-Z0-9.-]+(:[a-zA-Z0-9.&%$-]+)*@)*((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])){3}|([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+\.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(:[0-9]+)*(\/($|[a-zA-Z0-9.,?'\\+&%$#=~_-]+))*$/;
        if (pattern.test(url)) {
            return true;
        }
        return false;
    });
    jQuery('.button').click(function () {
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            var avatar = jQuery('#avatar');
            var banner = jQuery('#banner');
            if (avatar.val() != "") {
                var aSize = avatar[0].files[0].size;
                var aType = avatar[0].files[0].type;
                if (aSize > 419430)
                {
                    alert("Nie można przesłać pliku. Maksymalny rozmiar to 400 kb.");
                    return false;
                }
                switch (aType) {
                    case 'image/png':
                    case 'image/jpeg':
                        break;
                    default:
                        alert('Nie można przesłać pliku. Dopuszczalne są pliki graficzne w formacie jpg lub png.');
                        return false;
                }
            }
            if (banner.val() != "") {
                var bSize = banner[0].files[0].size;
                var bType = banner[0].files[0].type;
                if (bSize > 419430)
                {
                    alert("Nie można przesłać pliku. Maksymalny rozmiar to 400 kb.");
                    return false;
                }
                switch (bType) {
                    case 'image/png':
                    case 'image/jpeg':
                        break;
                    default:
                        alert('Nie można przesłać pliku. Dopuszczalne są pliki graficzne w formacie jpg lub png.');
                        return false;
                }
            }
        }
    });
    //]]>
</script>